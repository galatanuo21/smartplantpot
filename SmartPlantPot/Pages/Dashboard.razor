@page "/dashboard"
@inject NavigationManager NavManager
@inject UserService UserService
@inject HttpClient Http
@using System.Threading
@using SmartPlantPot.Models


@using static System.Net.WebRequestMethods

<div class="app-wrapper @(ZeigeEinstellungen || ZeigeAnalyse ? "settings-mode" : "")">

    @if (ZeigeEinstellungen)
    {
        // --- EINSTELLUNGEN ---
        <div class="settings-container fade-in">
            <h1 class="settings-header">Einstellungen</h1>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Wassermenge (ml)</span>
                    <span class="setting-value">@Einstellung_WasserMenge ml</span>
                </div>
                <input type="range" min="50" max="500" step="10"
                       @bind="Einstellung_WasserMenge" @bind:event="oninput"
                       class="custom-slider" />
            </div>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Dauer Gießvorgang</span>
                    <span class="setting-value" style="color:#32CD32; font-weight:bold;">@Einstellung_Dauer Sekunden</span>
                </div>
                <input type="range" min="1" max="60" step="1"
                       @bind="Einstellung_Dauer" @bind:event="oninput"
                       class="custom-slider" />
            </div>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Feuchtigkeitsschwelle</span>
                    <span class="setting-value">@Einstellung_Schwelle %</span>
                </div>
                <input type="range" min="10" max="90" step="5"
                       @bind="Einstellung_Schwelle" @bind:event="oninput"
                       @bind:after="PruefeAutomatikSofort"
                       class="custom-slider" />
            </div>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Prüf-Intervall</span>
                    <span class="setting-value">@Einstellung_Intervall Std.</span>
                </div>
                <input type="range" min="1" max="48" step="1"
                       @bind="Einstellung_Intervall" @bind:event="oninput"
                       @bind:after="UpdateAutoTimer"
                       class="custom-slider" />
            </div>

            <button class="btn-save" @onclick="BackToDashboard">Speichern & Zurück</button>
        </div>
    }
    else if (ZeigeAnalyse)
    {
        // --- ANALYSE ---
        <div class="settings-container fade-in">
            <h1 class="settings-header">Analyse</h1>

            <div class="analyse-card">
                <div class="card-title-small">Verlauf</div>
                <div class="chart-container">
                    <svg viewBox="0 0 300 100" class="chart-svg">
                        <defs>
                            <linearGradient id="gradientFill" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="#00ff44" stop-opacity="0.3" />
                                <stop offset="100%" stop-color="#00ff44" stop-opacity="0" />
                            </linearGradient>
                        </defs>
                        <line x1="0" y1="20" x2="300" y2="20" stroke="#eee" />
                        <line x1="0" y1="50" x2="300" y2="50" stroke="#eee" />
                        <line x1="0" y1="80" x2="300" y2="80" stroke="#eee" />
                        <path d="M0,80 C20,70 40,65 50,50 C60,30 80,10 100,8 C140,5 160,10 180,20 C200,40 220,60 240,60 L260,60 L300,80 V100 H0 Z" fill="url(#gradientFill)" />
                        <path d="M0,80 C20,70 40,65 50,50 C60,30 80,10 100,8 C140,5 160,10 180,20 C200,40 220,60 240,60 L260,60 L300,80" fill="none" stroke="#00a63f" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </div>
            </div>

            <div class="analyse-card flex-row">
                <div class="tank-visual">
                    <div class="tank-body">
                        <div class="tank-water" style="height: @TankFuellstand%;"></div>
                    </div>
                </div>
                <div class="tank-info">
                    <div class="tank-percent">@TankFuellstand %</div>
                    <div class="tank-label">Wasserstand</div>
                </div>
            </div>
            <button class="btn-save btn-back-white" @onclick="BackToDashboard">Zurück</button>
        </div>
    }
    else
    {
        <!-- DASHBOARD -->
        <div class="container fade-in">
            <div class="header">Smart Pot</div>

            <div class="card">
                <div class="card-title">Pflanze</div>
                <div class="sensor-grid">
                    <div class="sensor-block">
                        <div class="label">Bodenfeuchtigkeit</div>
                        <div class="value moisture" style="@(Bodenfeuchtigkeit <= Einstellung_Schwelle ? "color:red;" : "")">
                            @Bodenfeuchtigkeit %
                        </div>
                    </div>

                    <div class="sensor-block" style="@(PumpeLaeuft ? "background:#e6ffe6; border: 2px solid #32CD32;" : "")">
                        <div class="label">Status</div>
                        <div class="value temp" style="@(PumpeLaeuft ? "color:#32CD32;" : "")">
                            @(PumpeLaeuft ? $"Gießt... {RestdauerAnzeige}s" : "Bereit")
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn-fill" @onclick="ManuellGiessen" disabled="@PumpeLaeuft">
                        Manuell Gießen
                    </button>

                    <button class="btn-outline" @onclick="ToggleAutomatisch"
                            style="@(AutomatischAktiv ? "background:#32CD32; color:white; border-color:#32CD32" : "")">
                        @(AutomatischAktiv ? "Auto: AN" : "Auto: AUS")
                    </button>
                </div>

                @if (AutomatischAktiv && !PumpeLaeuft)
                {
                    <div style="text-align:center; font-size:11px; color:#888; margin-top:5px;">
                        Eingestellt: Gießen wenn unter <b>@Einstellung_Schwelle%</b> <br />
                        Aktuell: <b>@Bodenfeuchtigkeit%</b>
                        @(Bodenfeuchtigkeit <= Einstellung_Schwelle ? "(Wartet auf Timer...)" : "(Feuchtigkeit OK)")
                    </div>
                }

                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;" />

                <div class="history-title">Letzte Aktionen</div>

                @if (GießHistorie.Count == 0)
                {
                    <div class="history-empty">Noch keine Daten vorhanden.</div>
                }
                else
                {
                    <table class="history-table">
                        <tbody>
                            @foreach (var eintrag in GießHistorie.Take(3))
                            {
                                <tr><td>@eintrag.Art</td><td>@eintrag.Uhrzeit</td></tr>
                            }
                        </tbody>
                    </table>
                }
            </div>

            <div class="bottom-buttons">
                <button class="btn-white" @onclick="GoToAnalyse">Analyse</button>
                <button class="btn-white" @onclick="GoToSettings">Einstellungen</button>
            </div>
        </div>
    }
</div>

@code {
    // --- STATE ---
    int Bodenfeuchtigkeit = 0;
    bool AutomatischAktiv = false;
    bool PumpeLaeuft = false;
    int RestdauerAnzeige = 0;
    int TankFuellstand = 80;

    // --- NAVIGATION ---
    bool ZeigeEinstellungen = false;
    bool ZeigeAnalyse = false;

    // --- EINSTELLUNGEN ---
    int Einstellung_WasserMenge = 150;
    int Einstellung_Dauer = 5;
    int Einstellung_Schwelle = 30;
    int Einstellung_Intervall = 12;

    // --- SYSTEM ---
    Timer? CheckTimer;
    Timer? UpdateTimer;
    List<GießEintrag> GießHistorie = new();

    // --- API-DATEN ---
    List<Messwerte> MesswerteListe = new();

    protected override async Task OnInitializedAsync()
    {
        await LadeMesswerte();
        StartAutoUpdate();
    }

    async Task LadeMesswerte()
    {
        try
        {
            var daten = await Http.GetFromJsonAsync<List<Messwerte>>("api/humidity"); // Dein API-Endpunkt
            if (daten != null && daten.Any())
            {
                MesswerteListe = daten;
                // Aktuellster Wert = letzte Bodenfeuchtigkeit
                Bodenfeuchtigkeit = (int)Math.Round(MesswerteListe.Last().Humidity);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fehler beim Laden der API: {ex.Message}");
        }
    }

    void StartAutoUpdate()
    {
        UpdateTimer?.Dispose();
        UpdateTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LadeMesswerte();
                await PruefeAutomatikSofort();
            });
        }, null, 0, 5000); // alle 5 Sekunden aktualisieren
    }

    // === LOGIK ===

    void ManuellGiessen()
    {
        _ = StartGiessVorgang("Manuell");
    }

    async Task ToggleAutomatisch()
    {
        AutomatischAktiv = !AutomatischAktiv;
        UpdateAutoTimer();
        if (AutomatischAktiv) await PruefeAutomatikSofort();
    }

    void UpdateAutoTimer()
    {
        CheckTimer?.Dispose();
        if (AutomatischAktiv)
        {
            int timerIntervallMs = 5000;
            CheckTimer = new Timer(TimerCallback, null, 0, timerIntervallMs);
        }
    }

    async void TimerCallback(object? state)
    {
        await InvokeAsync(() => PruefeAutomatikSofort());
    }

    async Task PruefeAutomatikSofort()
    {
        if (!AutomatischAktiv || PumpeLaeuft || TankFuellstand <= 0) return;

        if (Bodenfeuchtigkeit <= Einstellung_Schwelle)
        {
            await StartGiessVorgang("Auto-Start");
        }

        StateHasChanged();
    }

    async Task StartGiessVorgang(string modus)
    {
        if (PumpeLaeuft || TankFuellstand <= 0) return;

        int dauerTest = Einstellung_Dauer;
        PumpeLaeuft = true;
        RestdauerAnzeige = dauerTest;
        StateHasChanged();

        while (RestdauerAnzeige > 0)
        {
            await Task.Delay(1000);
            RestdauerAnzeige--;
            StateHasChanged();
        }

        // Werte anpassen (simuliert)
        Bodenfeuchtigkeit = Math.Min(100, Bodenfeuchtigkeit + 30);
        TankFuellstand = Math.Max(0, TankFuellstand - 5);
        PumpeLaeuft = false;

        GießHistorie.Insert(0, new GießEintrag
        {
            Art = $"{modus} ({dauerTest}s)",
            Uhrzeit = DateTime.Now.ToString("HH:mm:ss")
        });

        StateHasChanged();
    }

    void GoToSettings() { ZeigeEinstellungen = true; ZeigeAnalyse = false; }
    void GoToAnalyse() { ZeigeAnalyse = true; ZeigeEinstellungen = false; }
    void BackToDashboard()
    {
        ZeigeEinstellungen = false;
        ZeigeAnalyse = false;
        if (AutomatischAktiv) _ = PruefeAutomatikSofort();
    }
    
    class GießEintrag
    {
        public string Art { get; set; } = "";
        public string Uhrzeit { get; set; } = "";
    }
}