@page "/dashboard"
@inject NavigationManager NavManager
@inject UserService UserService
@inject HttpClient Http
@using System.Threading
@using SmartPlantPot.Models
@using System.Text.Json @* WICHTIG: Für die JSON Optionen *@
@using static System.Net.WebRequestMethods
@using System.Net.Http.Json

<div class="app-wrapper @(ZeigeEinstellungen || ZeigeAnalyse ? "settings-mode" : "")">

    @if (ZeigeEinstellungen)
    {
        // --- EINSTELLUNGEN ---
        <div class="settings-container fade-in">
            <h1 class="settings-header">Einstellungen</h1>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Wassermenge (ml)</span>
                    <span class="setting-value">@Einstellung_WasserMenge ml</span>
                </div>
                <input type="range" min="50" max="500" step="10"
                       @bind="Einstellung_WasserMenge" @bind:event="oninput"
                       class="custom-slider" />
            </div>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Dauer Gießvorgang</span>
                    <span class="setting-value" style="color:#32CD32; font-weight:bold;">@Einstellung_Dauer Sekunden</span>
                </div>
                <input type="range" min="1" max="60" step="1"
                       @bind="Einstellung_Dauer" @bind:event="oninput"
                       class="custom-slider" />
            </div>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Feuchtigkeitsschwelle</span>
                    <span class="setting-value">@Einstellung_Schwelle %</span>
                </div>
                <input type="range" min="10" max="90" step="5"
                       @bind="Einstellung_Schwelle" @bind:event="oninput"
                       @bind:after="PruefeAutomatikSofort"
                       class="custom-slider" />
            </div>

            <div class="setting-card">
                <div class="setting-top">
                    <span class="setting-label">Prüf-Intervall</span>
                    <span class="setting-value">@Einstellung_Intervall Std.</span>
                </div>
                <input type="range" min="1" max="48" step="1"
                       @bind="Einstellung_Intervall" @bind:event="oninput"
                       @bind:after="UpdateAutoTimer"
                       class="custom-slider" />
            </div>

            <button class="btn-save" @onclick="BackToDashboard">Speichern & Zurück</button>
        </div>
    }
    else if (ZeigeAnalyse)
    {
        // --- ANALYSE ---
        <div class="settings-container fade-in">
            <h1 class="settings-header">Analyse</h1>

            <div class="analyse-card">
                <div class="card-title-small">Verlauf</div>
                <div class="chart-container">
                    <svg viewBox="0 0 300 100" class="chart-svg">
                        <defs>
                            <linearGradient id="gradientFill" x1="0" x2="0" y1="0" y2="1">
                                <stop offset="0%" stop-color="#00ff44" stop-opacity="0.3" />
                                <stop offset="100%" stop-color="#00ff44" stop-opacity="0" />
                            </linearGradient>
                        </defs>
                        <line x1="0" y1="20" x2="300" y2="20" stroke="#eee" />
                        <line x1="0" y1="50" x2="300" y2="50" stroke="#eee" />
                        <line x1="0" y1="80" x2="300" y2="80" stroke="#eee" />
                        <path d="M0,80 C20,70 40,65 50,50 C60,30 80,10 100,8 C140,5 160,10 180,20 C200,40 220,60 240,60 L260,60 L300,80 V100 H0 Z" fill="url(#gradientFill)" />
                        <path d="M0,80 C20,70 40,65 50,50 C60,30 80,10 100,8 C140,5 160,10 180,20 C200,40 220,60 240,60 L260,60 L300,80" fill="none" stroke="#00a63f" stroke-width="3" stroke-linecap="round" />
                    </svg>
                </div>
            </div>

            <div class="analyse-card flex-row">
                <div class="tank-visual">
                    <div class="tank-body">
                        <div class="tank-water" style="height: @TankFuellstand%;"></div>
                    </div>
                </div>
                <div class="tank-info">
                    <div class="tank-percent">@TankFuellstand %</div>
                    <div class="tank-label">Wasserstand</div>
                </div>
            </div>
            <button class="btn-save btn-back-white" @onclick="BackToDashboard">Zurück</button>
        </div>
    }
    else
    {
        <div class="container fade-in">
            <div class="header">Smart Pot</div>

            <div class="card">
                <div class="card-title">Pflanze</div>
                <div class="sensor-grid">
                    <div class="sensor-block">
                        <div class="label">Bodenfeuchtigkeit</div>
                        <div class="value moisture" style="@(Bodenfeuchtigkeit <= Einstellung_Schwelle ? "color:red;" : "")">
                            @Bodenfeuchtigkeit %
                        </div>
                    </div>

                    <div class="sensor-block" style="@(PumpeLaeuft ? "background:#e6ffe6; border: 2px solid #32CD32;" : "")">
                        <div class="label">Status</div>
                        <div class="value temp" style="@(PumpeLaeuft ? "color:#32CD32;" : "")">
                            @(PumpeLaeuft ? $"Gießt... {RestdauerAnzeige}s" : "Bereit")
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button class="btn-fill" @onclick="ManuellGiessen" disabled="@PumpeLaeuft">
                        Manuell Gießen
                    </button>

                    <button class="btn-outline" @onclick="ToggleAutomatisch"
                            style="@(AutomatischAktiv ? "background:#32CD32; color:white; border-color:#32CD32" : "")">
                        @(AutomatischAktiv ? "Auto: AN" : "Auto: AUS")
                    </button>
                </div>

                @if (AutomatischAktiv && !PumpeLaeuft)
                {
                    <div style="text-align:center; font-size:11px; color:#888; margin-top:5px;">
                        Eingestellt: Gießen wenn unter <b>@Einstellung_Schwelle%</b> <br />
                        Aktuell: <b>@Bodenfeuchtigkeit%</b>
                        @(Bodenfeuchtigkeit <= Einstellung_Schwelle ? "(Wartet auf Timer...)" : "(Feuchtigkeit OK)")
                    </div>
                }

                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;" />

                <div class="history-title">Letzte Aktionen</div>

                @if (GießHistorie.Count == 0)
                {
                    <div class="history-empty">Noch keine Daten vorhanden.</div>
                }
                else
                {
                    <table class="history-table">
                        <tbody>
                            @foreach (var eintrag in GießHistorie.Take(3))
                            {
                                <tr><td>@eintrag.Art</td><td>@eintrag.Uhrzeit</td></tr>
                            }
                        </tbody>
                    </table>
                }
            </div>

            <div class="bottom-buttons">
                <button class="btn-white" @onclick="GoToAnalyse">Analyse</button>
                <button class="btn-white" @onclick="GoToSettings">Einstellungen</button>
            </div>
        </div>
    }
</div>

@code {
    // --- STATE ---
    int Bodenfeuchtigkeit = 0;
    bool AutomatischAktiv = false;
    bool PumpeLaeuft = false;
    int RestdauerAnzeige = 0;
    int TankFuellstand = 80;

    // --- NAVIGATION ---
    bool ZeigeEinstellungen = false;
    bool ZeigeAnalyse = false;

    // --- EINSTELLUNGEN ---
    int Einstellung_WasserMenge = 150;
    int Einstellung_Dauer = 5;
    int Einstellung_Schwelle = 30;
    int Einstellung_Intervall = 12;

    // --- SYSTEM ---
    Timer? CheckTimer;
    Timer? UpdateTimer;
    List<GießEintrag> GießHistorie = new();

    // --- API-DATEN ---
    List<Messwerte> MesswerteListe = new();

    protected override async Task OnInitializedAsync()
    {
        await LadeMesswerte();
        StartAutoUpdate();
    }

    async Task LadeMesswerte()
    {
        try
        {
            // 1. Wir holen die Daten erst als reinen Text (String), um zu sehen, was ankommt
            var jsonString = await Http.GetStringAsync("api/humidity");

            // 2. WICHTIG: Schauen Sie jetzt in die Browser-Konsole (F12)!
            Console.WriteLine("ROHES JSON VOM SERVER: " + jsonString);

            // 3. Jetzt wandeln wir es manuell um
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            };

            var daten = JsonSerializer.Deserialize<List<Messwerte>>(jsonString, options);

            if (daten != null && daten.Any())
            {
                MesswerteListe = daten;

                // SIMPEL: Wir sortieren nach ID (1, 2, 3...)
                // Und nehmen einfach den LETZTEN (.Last)
                var letzterEintrag = MesswerteListe.OrderBy(x => x.Id).LastOrDefault();

                if (letzterEintrag != null)
                {
                    Bodenfeuchtigkeit = (int)Math.Round(letzterEintrag.Humidity);
                    Console.WriteLine($"Neuester Wert (ID: {letzterEintrag.Id}): {Bodenfeuchtigkeit}%");
                }

                StateHasChanged();
            }
            else
            {
                Console.WriteLine("Liste war nach Konvertierung leer.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"CRASH BEIM LADEN: {ex.Message}");
        }
    }

    void StartAutoUpdate()
    {
        UpdateTimer?.Dispose();
        UpdateTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LadeMesswerte();
                await PruefeAutomatikSofort();
            });
        }, null, 0, 5000); // alle 5 Sekunden aktualisieren
    }

    // === LOGIK ===

    void ManuellGiessen()
    {
        _ = StartGiessVorgang("Manuell");
    }

    async Task ToggleAutomatisch()
    {
        AutomatischAktiv = !AutomatischAktiv;
        UpdateAutoTimer();
        if (AutomatischAktiv) await PruefeAutomatikSofort();
    }

    void UpdateAutoTimer()
    {
        CheckTimer?.Dispose();
        if (AutomatischAktiv)
        {
            int timerIntervallMs = 5000;
            CheckTimer = new Timer(TimerCallback, null, 0, timerIntervallMs);
        }
    }

    async void TimerCallback(object? state)
    {
        await InvokeAsync(() => PruefeAutomatikSofort());
    }

    async Task PruefeAutomatikSofort()
    {
        if (!AutomatischAktiv || PumpeLaeuft || TankFuellstand <= 0) return;

        if (Bodenfeuchtigkeit <= Einstellung_Schwelle)
        {
            await StartGiessVorgang("Auto-Start");
        }

        StateHasChanged();
    }

    // Die Klasse, die wir an die API schicken (muss exakt so heißen wie im Controller)
    public class MessungEintragDto
    {
        public double Humidity { get; set; }
        public string Modus { get; set; }
    }

    async Task StartGiessVorgang(string modus)
    {
        if (PumpeLaeuft || TankFuellstand <= 0) return;

        // Hier nutzen wir jetzt die eingestellte Dauer
        int dauerTest = Einstellung_Dauer;

        PumpeLaeuft = true;
        RestdauerAnzeige = dauerTest;
        StateHasChanged();

        // Countdown abwarten
        while (RestdauerAnzeige > 0)
        {
            await Task.Delay(1000);
            RestdauerAnzeige--;
            StateHasChanged();
        }

        // --- HIER IST DIE NEUE BERECHNUNG ---

        // 1. Feuchtigkeitsanstieg berechnen basierend auf Wassermenge
        // Formel: Wir teilen die ml durch 5.
        // Beispiel: 150ml / 5 = +30% Feuchtigkeit.
        //           500ml / 5 = +100% Feuchtigkeit.
        double anstieg = Einstellung_WasserMenge / 5.0;

        double neueFeuchtigkeit = Math.Min(100, Bodenfeuchtigkeit + anstieg);

        // 2. Tankverbrauch berechnen basierend auf Wassermenge
        // Beispiel: Wenn 150ml etwa 5% Tankinhalt sind (Faktor 30)
        double tankVerbrauch = Einstellung_WasserMenge / 30.0;

        // Wir ziehen den Verbrauch ab, dürfen aber nicht unter 0 fallen
        TankFuellstand = (int)Math.Max(0, TankFuellstand - tankVerbrauch);

        // ------------------------------------

        PumpeLaeuft = false;
        Bodenfeuchtigkeit = (int)neueFeuchtigkeit;

        // 4. --- DATEN AN API SCHICKEN ---
        try
        {
            var paket = new MessungEintragDto
            {
                Humidity = neueFeuchtigkeit,
                Modus = modus
            };

            var antwort = await Http.PostAsJsonAsync("api/messwerte", paket);

            if (!antwort.IsSuccessStatusCode)
            {
                Console.WriteLine($"API Fehler: {antwort.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Verbindungsfehler: {ex.Message}");
        }

        // 5. Historie fortschreiben (jetzt mit Menge in der Anzeige!)
        GießHistorie.Insert(0, new GießEintrag
        {
            // Zeigt jetzt z.B. "Manuell (150ml)" an
            Art = $"{modus} ({Einstellung_WasserMenge}ml)",
            Uhrzeit = DateTime.Now.ToString("HH:mm:ss")
        });

        StateHasChanged();
    }
    void GoToSettings() { ZeigeEinstellungen = true; ZeigeAnalyse = false; }
    void GoToAnalyse() { ZeigeAnalyse = true; ZeigeEinstellungen = false; }
    void BackToDashboard()
    {
        ZeigeEinstellungen = false;
        ZeigeAnalyse = false;
        if (AutomatischAktiv) _ = PruefeAutomatikSofort();
    }

    class GießEintrag
    {
        public string Art { get; set; } = "";
        public string Uhrzeit { get; set; } = "";
    }
  
}